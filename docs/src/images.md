```@meta
CurrentModule = SMLMSim
```

# Microscope Image Generation

This page explains how to generate realistic microscope images from simulated SMLM data and the available noise options.

## Overview

SMLMSim can convert SMLD objects containing emitter coordinates into realistic microscope image stacks using point spread function (PSF) models. This functionality enables:

- Creating synthetic microscope data for algorithm testing
- Visualizing simulated molecules
- Generating training data for deep learning models
- Testing localization algorithms with realistic inputs

## Basic Image Generation

The primary functions for creating images are:

- `gen_images`: Generate multiple frames (3D stack)
- `gen_image`: Generate a single frame (2D image)

### Creating a Full Image Stack

To generate a complete image stack from an SMLD object:

```julia
using SMLMSim
using MicroscopePSFs

# Create or load an SMLD object
# (This could be from either static or diffusion simulation)
camera = IdealCamera(128, 128, 0.1)
smld_true, smld_model, smld_noisy = simulate(pattern=Nmer2D(), camera=camera)

# Create a PSF model (Gaussian with 150nm width)
psf = MicroscopePSFs.GaussianPSF(0.15)  # 150nm PSF width

# Generate image stack from emitter data
images = gen_images(smld_noisy, psf;
    photons=1000.0,     # photons per emitter
    bg=5.0,             # background photons per pixel
    poisson_noise=true  # add realistic photon counting noise
)
```

The resulting `images` is a 3D array with dimensions `[height, width, frames]` that can be used for visualization or algorithm development.

### Creating a Single Frame

To generate an image for a specific frame:

```julia
# Generate image for frame 10
frame_image = gen_image(smld_noisy, psf, 10;
    photons=1000.0,
    bg=5.0,
    poisson_noise=true
)
```

## Noise Options

Realistic microscope images include various noise sources. SMLMSim supports the following options:

### Photon Shot Noise

Photon shot noise follows a Poisson distribution and is the most fundamental noise source in fluorescence microscopy:

```julia
# Enable Poisson noise (default: false)
images = gen_images(smld, psf, poisson_noise=true)
```

When enabled, each pixel's intensity is drawn from a Poisson distribution with Î» equal to the expected photon count.

### Background Signal

Background noise can be added as a constant offset to all pixels:

```julia
# Add background signal (photons per pixel)
images = gen_images(smld, psf, bg=10.0)
```

When combined with Poisson noise, the background is included in the Poisson sampling process for a realistic noise model.

### Frame Integration

For diffusion simulations, multiple time steps can be integrated into a single camera frame:

```julia
# Integrate multiple simulation steps into each output frame
images = gen_images(smld, psf, frame_integration=10)
```

This models exposure time effects, where molecules moving during the camera exposure create motion blur or integrated signals.

## Working with Image Stacks

The generated images can be visualized using various Julia plotting libraries:

```julia
using Makie  # or CairoMakie, GLMakie, etc.

# Display a single frame
heatmap(images[:, :, 10], colormap=:inferno)

# Create a movie from all frames
frames = @animate for i in 1:size(images, 3)
    heatmap(images[:, :, i], colormap=:inferno)
end

# Save the animation
save("smlm_simulation.mp4", frames)
```

## Integration with Other Packages

The image stacks generated by SMLMSim are compatible with various Julia image processing packages:

```julia
using Images

# Apply preprocessing
processed = mapslices(img -> imfilter(img, Kernel.gaussian(3)), 
                     images, dims=[1, 2])

# Extract specific frame
frame5 = images[:, :, 5]

# Save as TIFF
save("frame5.tif", frame5)
```